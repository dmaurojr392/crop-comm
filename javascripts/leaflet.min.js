let map,mapHint=document.getElementById("map-hint"),mapDetails=document.getElementById("map-details"),selectedCrop=null,commodityColors={Banana:"#FFFFA3",Sugarcane:"#DEAA79",Onion:"#B7B1F2",Coconut:"#A3FFB2",Corn:"#FADA7A",Mango:"#A3FFFF",Cashew:"#C7B7A3",Cogon:"#73A9AD",Sitao:"#A3D1A3",Camote:"#FFA3FF",Cassava:"#D1B38A",Tomato:"#FFA3A3"};function getCommodityColor(o){return commodityColors[o]||"#000"}function updateLegend(o){let e=document.getElementById("map-legend");if(!e)return;let a="<h4>Crop Legend</h4>";({TopCrop:[{name:"Banana",color:"#FFFFA3"},{name:"Coconut",color:"#A3FFB2"},{name:"Corn",color:"#FADA7A"},{name:"Mango",color:"#A3FFFF"},{name:"Onion",color:"#B7B1F2"},{name:"Sugarcane",color:"#DEAA79"}],SecondCrop:[{name:"Cashew",color:"#C7B7A3"},{name:"Cogon",color:"#73A9AD"},{name:"Corn",color:"#FADA7A"},{name:"Sitao",color:"#A3D1A3"},{name:"Sugarcane",color:"#DEAA79"}],ThirdCrop:[{name:"Banana",color:"#FFFFA3"},{name:"Camote",color:"#FFA3FF"},{name:"Cassava",color:"#D1B38A"},{name:"Coconut",color:"#A3FFB2"},{name:"Mango",color:"#A3FFFF"},{name:"Tomato",color:"#FFA3A3"}]}[o]||[]).forEach((o=>{a+=`<i style="background:${o.color}; width: 15px; border: 1px solid gray; height: 15px; display: inline-block; margin-right: 5px;"></i> ${o.name}<br>`})),e.innerHTML=a}function getMap(){void 0!==map&&map.remove(),map=L.map("map").setView([15.5,120.5],8);const o=[[4.2158,116.7017],[21.3213,126.6052]];map.setMaxBounds(o),map.on("drag",(function(){map.panInsideBounds(o,{animate:!0})})),L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:20}).addTo(map);let e=L.control({position:"topright"});e.onAdd=function(o){const e=L.DomUtil.create("div","info legend");return e.id="map-legend",e},e.addTo(map),fetch("data/cropData.json").then((o=>o.json())).then((o=>{L.geoJSON(o,{style:function(o){return{fillColor:"transparent",color:"transparent",weight:1,interactive:!0}},onEachFeature:function(o,e){console.log(o.properties.ADM2_EN),e.on({click:function(){sideContent(o),document.getElementById("crop-data-loading").classList.remove("d-none"),document.getElementById("crop-data-loading").classList.add("d-flex"),document.getElementById("crop-data").classList.add("d-none"),fetchPredictions(o),mapHint.classList.remove("d-lg-flex"),mapHint.classList.add("d-none"),mapDetails.classList.remove("d-none"),mapDetails.classList.add("d-block"),e.getBounds?map.fitBounds(e.getBounds()):e.getLatLng&&map.setView(e.getLatLng(),map.getZoom()+1)},mouseover:function(){e.setStyle({fillOpacity:1,color:"gray",weight:1})},mouseout:function(){e.setStyle({fillOpacity:1,color:"transparent",weight:1})}})}}).addTo(map)})),initialize();const a=getAuroraCommodity(),t=getBataanCommodity(),n=getBulacanCommodity(),r=getNuevaEcijaCommodity(),i=getPampangaCommodity(),d=getTarlacCommodity(),c=getZambalesCommodity();console.log(a,t,n,r,i,d,c);const s=[{url:`data/aurora-${a}-2023.json`,colorConfig:{TopCrop:"Coconut",SecondCrop:"Corn",ThirdCrop:"Banana"}},{url:`data/bataan-${t}-2023.json`,colorConfig:{TopCrop:"Corn",SecondCrop:"Cashew",ThirdCrop:"Coconut"}},{url:`data/bulacan-${n}-2023.json`,colorConfig:{TopCrop:"Banana",SecondCrop:"Sitao",ThirdCrop:"Mango"}},{url:`data/ne-${r}-2023.json`,colorConfig:{TopCrop:"Onion",SecondCrop:"Corn",ThirdCrop:"Tomato"}},{url:`data/pampanga-${i}-2023.json`,colorConfig:{TopCrop:"Sugarcane",SecondCrop:"Corn",ThirdCrop:"Cassava"}},{url:`data/tarlac-${d}-2023.json`,colorConfig:{TopCrop:"Corn",SecondCrop:"Sugarcane",ThirdCrop:"Camote"}},{url:`data/zambales-${c}-2023.json`,colorConfig:{TopCrop:"Mango",SecondCrop:"Cogon",ThirdCrop:"Banana"}}];function l(o){return fetch(o.url).then((o=>{if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);return o.json()})).then((e=>(L.geoJSON(e,{renderer:L.canvas(),style:function(e){let a;if(o.fixedColor)a=o.fixedColor;else{const e=localStorage.getItem("rank-for-leading-crop-map");a=getCommodityColor(o.colorConfig[e])}return{fillColor:a,fillOpacity:1,color:a,weight:1,interactive:!0}},onEachFeature:function(o,e){e.on("click",(()=>{sideContent(o)}))}}).addTo(map),!0))).catch((e=>(console.error(`Error fetching ${o.url}:`,e),!1)))}!function(){!function(){const o=document.createElement("div");o.className="modal fade show d-block",o.id="loadingModal",o.setAttribute("data-bs-backdrop","static"),o.setAttribute("data-bs-keyboard","false"),o.tabIndex=-1,o.style.backgroundColor="rgba(0,0,0,0.2)",o.innerHTML='\n            <div class="modal-dialog modal-dialog-centered" style="background: transparent; box-shadow: none;">\n                <div class="modal-content" style="background: transparent; border: none;">\n                    <div class="modal-body text-center" style="background: transparent; border: none;">\n                        <div class="w-100 d-flex justify-content-center" style="background: transparent;">\n                            <div class="loader"></div>\n                        </div>\n                        <p class="mt-3 text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Loading map data...</p>\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(o);const e=document.createElement("div");e.className="modal-backdrop fade show",document.body.appendChild(e)}();const o=s.map(l);Promise.all(o).then((o=>{const e=o.filter(Boolean).length;console.log(`Successfully loaded ${e}/${s.length} datasets`)})).catch((o=>{console.error("Error loading datasets:",o)})).finally((()=>{!function(){const o=document.getElementById("loadingModal"),e=document.querySelector(".modal-backdrop");o&&(o.classList.remove("show"),o.classList.add("fade"),setTimeout((()=>o.remove()),150)),e&&(e.classList.remove("show"),setTimeout((()=>e.remove()),150))}()}))}(),console.log(selectedCrop)}function getAuroraCommodity(){const o=localStorage.getItem("rank-for-leading-crop-map");return"TopCrop"==o?"coconut":"SecondCrop"==o?"corn":"ThirdCrop"==o?"banana":"coconut"}function getBataanCommodity(){const o=localStorage.getItem("rank-for-leading-crop-map");return"TopCrop"==o?"corn":"SecondCrop"==o?"cashew":"coconut"}function getBulacanCommodity(){const o=localStorage.getItem("rank-for-leading-crop-map");return"TopCrop"==o?"banana":"SecondCrop"==o?"sitao":"ThirdCrop"==o?"mango":"banana"}function getNuevaEcijaCommodity(){const o=localStorage.getItem("rank-for-leading-crop-map");return"TopCrop"==o?"onion":"SecondCrop"==o?"corn":"ThirdCrop"==o?"tomato":"onion"}function getPampangaCommodity(){const o=localStorage.getItem("rank-for-leading-crop-map");return"TopCrop"==o?"sugarcane":"SecondCrop"==o?"corn":"ThirdCrop"==o?"cassava":"sugarcane"}function getTarlacCommodity(){const o=localStorage.getItem("rank-for-leading-crop-map");return"TopCrop"==o?"corn":"SecondCrop"==o?"sugarcane":"ThirdCrop"==o?"camote":"corn"}function getZambalesCommodity(){const o=localStorage.getItem("rank-for-leading-crop-map");return"TopCrop"==o?"mango":"SecondCrop"==o?"cogon":"ThirdCrop"==o?"banana":"mango"}function sideContent(o){const e=document.getElementById("sidebar-title"),a=document.getElementById("sidebar-content");"TopCrop"==localStorage.getItem("rank-for-leading-crop-map")&&(e.innerHTML=`<div class="animate__animated animate__fadeIn"> ${o.properties.ADM2_EN} </div>`||"Not set",a.innerHTML=`\n            <div class="animate__animated animate__fadeIn"><strong>Leading Crop:</strong> ${o.properties.Top1_Commodities||"No data found"}</div>\n            <div class="animate__animated animate__fadeIn"><strong>Production:</strong> ${o.properties["Yield(MT)"]||"No data found"} Metric Tons</div>\n            <div class="animate__animated animate__fadeIn"><strong>Harvest Year: </strong>2023</div>\n        `),"SecondCrop"==localStorage.getItem("rank-for-leading-crop-map")&&(e.innerHTML=`<div class="animate__animated animate__fadeIn"> ${o.properties.ADM2_EN} </div>`||"Not set",a.innerHTML=`\n            <div class="animate__animated animate__fadeIn"><strong>Second Leading Crop:</strong> ${o.properties.Top2_Commodities||"No data found"}</div>\n            <div class="animate__animated animate__fadeIn"><strong>Production:</strong> ${o.properties["Yield(MT)_1"]||"No data found"} Metric Tons</div>\n            <div class="animate__animated animate__fadeIn"><strong>Harvest Year: </strong>2023</div>\n        `),"ThirdCrop"==localStorage.getItem("rank-for-leading-crop-map")&&(e.innerHTML=`<div class="animate__animated animate__fadeIn"> ${o.properties.ADM2_EN} </div>`||"Not set",a.innerHTML=`\n            <div class="animate__animated animate__fadeIn"><strong>Third Leading Crop:</strong> ${o.properties.Top3_Commodities||"No data found"}</div>\n            <div class="animate__animated animate__fadeIn"><strong>Production:</strong> ${o.properties["Yield(MT)_2"]||"No data found"} Metric Tons</div>\n            <div class="animate__animated animate__fadeIn"><strong>Harvest Year: </strong>2023</div>\n        `)}function initialize(){selectedCrop=document.getElementById("rank-for-leading-crop-map").value,localStorage.setItem("rank-for-leading-crop-map",selectedCrop),updateLegend(selectedCrop),mapHint.classList.remove("d-none"),mapHint.classList.add("d-lg-flex"),mapDetails.classList.add("d-none"),mapDetails.classList.remove("d-block")}function updateCropFilter(){initialize(),getMap()}let onionChart=null;async function fetchPredictions(o){try{let e=o.properties.ADM2_EN,a=null;"Aurora"==e&&(a=await fetch("https://fastapiserver-8aib.onrender.com/predict/aurora")),"Bataan"==e&&(a=await fetch("https://fastapiserver-8aib.onrender.com/predict/bataan"),console.log("Bataan Clicked")),"Bulacan"==e&&(a=await fetch("https://fastapiserver-8aib.onrender.com/predict/bulacan")),"Nueva Ecija"==e&&(a=await fetch("https://fastapiserver-8aib.onrender.com/predict/nueva-ecija")),"Pampanga"==e&&(a=await fetch("https://fastapiserver-8aib.onrender.com/predict/pampanga")),"Tarlac"==e&&(a=await fetch("https://fastapiserver-8aib.onrender.com/predict/tarlac")),"Zambales"==e&&(a=await fetch("https://fastapiserver-8aib.onrender.com/predict/zambales"));const t=await a.json();console.log("Fetched Data:",t);const n=document.getElementById("prediction");if(t.error)return void(n.innerHTML=`<p style='color: red;'>Error: ${t.error}</p>`);document.getElementById("crop-data-loading").classList.add("d-none"),document.getElementById("crop-data").classList.remove("d-none"),document.getElementById("crop-data").classList.add("d-block");let r=null;if("TopCrop"==localStorage.getItem("rank-for-leading-crop-map")?(r=t.predictions[o.properties.Top1_Commodities],n.innerHTML=`<h5>PREDICTED YIELD FOR ${o.properties.Top1_Commodities.toUpperCase()||"No data found"} (2023-2029)</h5>`):"SecondCrop"==localStorage.getItem("rank-for-leading-crop-map")?(r=t.predictions[o.properties.Top2_Commodities],n.innerHTML=`<h5>PREDICTED YIELD FOR ${o.properties.Top2_Commodities.toUpperCase()||"No data found"} (2023-2029)</h5>`):"ThirdCrop"==localStorage.getItem("rank-for-leading-crop-map")&&(r=t.predictions[o.properties.Top3_Commodities],n.innerHTML=`<h5>PREDICTED YIELD FOR ${o.properties.Top3_Commodities.toUpperCase()||"No data found"} (2023-2029)</h5>`),console.log("Result Data:",r),!r)return void(n.innerHTML+="<p>No data available for this crop.</p>");const i=Object.keys(r),d=Object.values(r);console.log("Years:",i,"Values:",d);const c=document.getElementById("onionChart");if(!c)return void console.error("Chart canvas not found!");const s=c.getContext("2d");onionChart&&onionChart.destroy(),"TopCrop"==localStorage.getItem("rank-for-leading-crop-map")?chartColor=getCommodityColor(o.properties.Top1_Commodities):"SecondCrop"==localStorage.getItem("rank-for-leading-crop-map")?chartColor=getCommodityColor(o.properties.Top2_Commodities):"ThirdCrop"==localStorage.getItem("rank-for-leading-crop-map")&&(chartColor=getCommodityColor(o.properties.Top3_Commodities)),onionChart=new Chart(s,{type:"bar",data:{labels:i,datasets:[{data:d,borderColor:chartColor,backgroundColor:chartColor,borderWidth:1,fill:!0}]},options:{responsive:!0,plugins:{title:{display:!1},legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})}catch(o){console.error("Error fetching data:",o),document.getElementById("results").innerHTML="<p style='color: red;'>Failed to fetch predictions.</p>"}}